# 実装計画

- [x] 1. プロジェクト構造とFirebase設定
  - React + TypeScriptプロジェクトの初期化（Vite使用）
  - Firebase SDKのインストールと設定（Firestore、Authentication）
  - Cloudflare Workers用のプロジェクト構造を作成
  - 環境変数の設定（.env.example作成）
  - _要件: 10.1, 10.2, 10.4_

- [x] 2. データモデルとTypeScript型定義の実装
  - すべてのデータモデルのTypeScript interfaceを定義
  - ノードスタイルのプリセット定数を実装
  - バリデーション関数を実装（ノードタイプ、トピックID必須等）
  - _要件: 1.2, 9.1_

- [x] 2.1 プロパティテスト: ノードタイプの検証
  - **プロパティ2: ノードタイプの検証**
  - **検証対象: 要件 1.2**

- [x] 2.2 プロパティテスト: トピック関連付けの必須性
  - **プロパティ4: トピック関連付けの必須性**
  - **検証対象: 要件 1.1, 9.1**

- [x] 3. Firebase認証サービスの実装
  - AuthServiceインターフェースの実装
  - Firebase Authenticationとの統合
  - ユーザー役割（教師/学生）の判定ロジック
  - セッション管理とトークン検証
  - _要件: 8.1, 8.2, 8.5_

- [x] 3.1 プロパティテスト: 役割ベースの機能アクセス
  - **プロパティ14: 役割ベースの機能アクセス**
  - **検証対象: 要件 8.2, 8.3, 8.4**

- [x] 3.2 プロパティテスト: セッション期限切れ時の再認証
  - **プロパティ15: セッション期限切れ時の再認証**
  - **検証対象: 要件 8.5**

- [x] 4. Firestoreデータアクセス層の実装
  - Firestoreコレクションの初期化とインデックス設定
  - 基本的なCRUD操作のヘルパー関数
  - トランザクション処理のユーティリティ
  - _要件: 1.4, 1.5_

- [x] 4.1 プロパティテスト: 概念マップの永続化ラウンドトリップ
  - **プロパティ1: 概念マップの永続化ラウンドトリップ**
  - **検証対象: 要件 1.4, 1.5**

- [ ] 5. 概念マップサービスの実装
- [ ] 5.1 概念マップの作成機能
  - createMap関数の実装
  - 所有者とトピックの関連付け
  - 見本マップフラグの設定
  - _要件: 1.1, 2.1, 5.4_

- [ ] 5.2 プロパティテスト: 見本マップのマーキング
  - **プロパティ5: 見本マップのマーキング**
  - **検証対象: 要件 2.1**

- [ ] 5.3 ノードとリンクの追加機能
  - addNode関数の実装（タイプ検証、スタイル自動設定）
  - addLink関数の実装（関係性の保存）
  - _要件: 1.2, 1.3_

- [ ] 5.4 プロパティテスト: リンクの関係性保存
  - **プロパティ3: リンクの関係性保存**
  - **検証対象: 要件 1.3**

- [ ] 5.5 概念マップの取得機能
  - getMap、getMapsByTopic、getMapsByUser関数の実装
  - 権限チェック（canEdit、canView）の実装
  - トピック別のグループ化ロジック
  - _要件: 5.1, 5.2, 5.3, 9.3_

- [ ] 5.6 プロパティテスト: 所有者ベースのアクセス制御
  - **プロパティ11: 所有者ベースのアクセス制御**
  - **検証対象: 要件 5.1, 5.2, 5.3, 5.4**

- [ ] 5.7 プロパティテスト: トピック別の整理
  - **プロパティ17: トピック別の整理**
  - **検証対象: 要件 9.3**

- [ ] 5.8 概念マップの更新・削除機能
  - updateMap、removeNode、removeLink、deleteMap関数の実装
  - 所有者検証の統合
  - _要件: 1.5, 5.2_

- [ ] 6. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 7. LLMアダプターの実装
  - LLMAdapterインターフェースの実装
  - LM Studio (OpenAI互換API) との統合
  - 語彙調整ロジック（ノードラベルとリンク関係性の調整）
  - エラーハンドリング（タイムアウト、接続失敗）
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 7.1 プロパティテスト: 語彙調整の非破壊性
  - **プロパティ13: 語彙調整の非破壊性**
  - **検証対象: 要件 7.4**

- [ ] 8. 比較サービスの実装
- [ ] 8.1 比較作成の基本機能
  - createOneToOneComparison関数の実装
  - トピック境界の検証
  - LLMアダプターの呼び出し
  - 比較結果のFirestore保存
  - _要件: 3.1, 3.5, 9.2_

- [ ] 8.2 プロパティテスト: 語彙調整の必須実行
  - **プロパティ8: 語彙調整の必須実行**
  - **検証対象: 要件 3.5**

- [ ] 8.3 プロパティテスト: トピック境界の尊重
  - **プロパティ16: トピック境界の尊重**
  - **検証対象: 要件 9.2**

- [ ] 8.4 複数マップ比較モードの実装
  - createTeacherToAllComparison関数の実装
  - createAllStudentsComparison関数の実装
  - createPartialStudentsComparison関数の実装
  - _要件: 3.2, 3.3, 3.4_

- [ ] 8.5 プロパティテスト: 比較モードの正確性
  - **プロパティ7: 比較モードの正確性**
  - **検証対象: 要件 3.1, 3.2, 3.3, 3.4**

- [ ] 8.6 類似度と差異の計算
  - ノードマッチングアルゴリズムの実装
  - リンクマッチングアルゴリズムの実装
  - 類似度スコアの計算
  - 固有ノード・リンクの抽出
  - _要件: 3.5_

- [ ] 8.7 比較結果の取得機能
  - getComparison、getAccessibleComparisons関数の実装
  - 権限チェックの統合
  - _要件: 6.1, 6.2, 6.3_

- [ ] 8.8 プロパティテスト: 比較結果の構造完全性
  - **プロパティ12: 比較結果の構造完全性**
  - **検証対象: 要件 6.2, 6.4**

- [ ] 9. 権限サービスの実装
  - PermissionServiceインターフェースの実装
  - grantViewPermission、revokeViewPermission関数の実装
  - canViewComparison関数の実装
  - デフォルト非公開設定の実装
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 9.1 プロパティテスト: 比較のデフォルト非公開性
  - **プロパティ9: 比較のデフォルト非公開性**
  - **検証対象: 要件 4.1**

- [ ] 9.2 プロパティテスト: 権限のラウンドトリップ
  - **プロパティ10: 権限のラウンドトリップ**
  - **検証対象: 要件 4.2, 4.3, 4.4, 6.1, 6.3**

- [ ] 10. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 11. Cloudflare Workers APIの実装
  - API Gatewayの実装（ルーティング）
  - 認証ミドルウェアの実装
  - 各サービスのエンドポイント実装
  - エラーハンドリングとレスポンス形式の統一
  - CORS設定
  - _要件: 8.3, 8.4_

- [ ] 12. Reactフロントエンドの基本構造
  - ルーティング設定（React Router）
  - 認証コンテキストの実装
  - レイアウトコンポーネント（ヘッダー、ナビゲーション）
  - _要件: 8.3, 8.4_

- [ ] 13. 認証UIの実装
  - ログインページの実装
  - ログアウト機能の実装
  - 役割に応じたナビゲーション表示
  - _要件: 8.1, 8.3, 8.4_

- [ ] 14. トピック管理UIの実装
  - トピック一覧表示
  - トピック作成フォーム（教師のみ）
  - トピック選択機能
  - _要件: 9.1, 9.3_

- [ ] 15. 概念マップエディタUIの実装
- [ ] 15.1 キャンバスコンポーネントの実装
  - React FlowまたはReactFlowを使用したキャンバス
  - ドラッグ&ドロップ機能
  - ズーム・パン機能
  - _要件: 1.1_

- [ ] 15.2 ノード作成・編集UIの実装
  - ダブルクリックでノード作成ダイアログ
  - ノードタイプ選択（名詞/動詞）
  - ラベル入力
  - 色選択（タイプに応じた色パレット）
  - スタイルの自動適用（角張った/丸い）
  - _要件: 1.2_

- [ ] 15.3 リンク作成・編集UIの実装
  - ノード間のドラッグでリンク作成
  - 関係性入力ダイアログ
  - リンクの視覚的表現（矢印、ラベル）
  - _要件: 1.3_

- [ ] 15.4 概念マップの保存・読み込み機能
  - 保存ボタンとAPIコール
  - 自動保存機能（オプション）
  - マップ一覧からの読み込み
  - _要件: 1.4, 1.5_

- [ ] 16. 概念マップ一覧UIの実装
  - 学生用: 自分のマップ一覧（トピック別）
  - 教師用: すべてのマップ一覧（トピック別、学生別）
  - マップのプレビュー表示
  - 編集・削除ボタン
  - _要件: 5.1, 9.3_

- [ ] 17. 比較機能UIの実装（教師用）
- [ ] 17.1 比較モード選択UI
  - 4つの比較モードの選択インターフェース
  - マップ選択UI（モードに応じて）
  - 比較実行ボタン
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 17.2 比較結果表示UI
  - 並列表示（2つ以上のマップを横に並べる）
  - 語彙調整後のノード・リンクの表示
  - 類似度スコアの表示
  - マッチングの視覚的ハイライト
  - 差異の表示（固有ノード・リンク）
  - _要件: 6.2_

- [ ] 17.3 権限管理UI
  - 学生選択チェックボックス
  - 権限付与・取り消しボタン
  - 現在の権限状態の表示
  - _要件: 4.2, 4.3_

- [ ] 18. 比較閲覧UIの実装（学生用）
  - 許可された比較一覧の表示
  - 比較結果の閲覧（教師用と同じ表示）
  - アクセス権限のない比較へのアクセス制限
  - _要件: 6.1, 6.2, 6.3_

- [ ] 19. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 20. プロパティテスト: 比較結果の不変性
  - **プロパティ6: 比較結果の不変性**
  - **検証対象: 要件 2.3**

- [ ] 21. エラーハンドリングとユーザーフィードバック
  - エラーメッセージコンポーネントの実装
  - ローディング状態の表示
  - 成功メッセージのトースト通知
  - LLMエラー時のフォールバック表示
  - _要件: 7.5_

- [ ] 22. Cloudflareデプロイ設定
  - wrangler.tomlの設定
  - Cloudflare Pagesの設定
  - 環境変数の設定（本番環境）
  - ビルドスクリプトの作成
  - _要件: 10.1, 10.5_

- [ ] 23. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する
