# 要件定義書

## はじめに

本システムは、学生が概念マップを自由に作成し、教師の見本や他の学生の概念マップと比較できる教育支援プラットフォームです。概念マップはノード（名詞または動詞）とリンク（関係性）で構成され、LLMを活用して語彙の違いを調整することで、異なる表現でも意味的に類似した概念を比較可能にします。教師は学生の理解度を把握し、学生は自身の学習を振り返ることができます。

## 用語集

- **システム**: Peer Resonant Concept Mapping システム
- **教師**: 教師ユーザー。概念マップの見本を作成し、学生の概念マップと比較する権限を持つ
- **学生**: 学生ユーザー。概念マップを作成し、許可された比較結果を閲覧する
- **概念マップ**: ノードとリンクで構成される知識の視覚的表現
- **ノード**: 概念マップのノード。名詞または動詞で表現される概念
- **リンク**: 概念マップのリンク。ノード間の関係性を表現する
- **トピック**: 概念マップの主題。同じトピックの概念マップのみが比較可能
- **語彙調整**: LLMを使用して異なる表現の語彙を意味的に統一する処理
- **比較**: 2つ以上の概念マップを語彙調整後に比較する機能
- **LLMサービス**: 語彙調整に使用する言語モデル（gpt-oss-20BまたはLM Studio経由の任意のLLM）
- **Firestoreデータベース**: peer-resonant-concept-map2プロジェクトのFirestoreデータベース
- **Firebase認証**: ユーザー認証に使用するFirebase Authenticationサービス

## グローバルルール

1. すべてのデータ操作は、Firestoreデータベース（peer-resonant-concept-map2）を通じて行う
2. すべてのユーザー認証は、Firebase認証を使用する
3. 概念マップの比較は、同じトピック内でのみ実行可能とする
4. 語彙調整は、比較実行時に必ずLLMサービスを経由して行う
5. 学生は、明示的に許可されない限り、他の学生の概念マップにアクセスできない
6. すべてのユーザーアクションは、適切な権限チェックを経てから実行する
7. アプリケーションは、Cloudflareインフラストラクチャ上にデプロイする
8. ソースコードは、GitHubリポジトリ（yusuke-hayashi/PeerResonantConceptMapping2）で管理する

## 要件

### 要件1

**ユーザーストーリー:** 学生として、ノードとリンクを使って概念マップを作成したい。そうすることで、トピックに対する自分の理解を視覚化し整理できる。

#### 受入基準

1. 学生が新しい概念マップを作成するとき、システムは特定のトピックに関連付ける
2. 学生が概念マップにノードを追加するとき、システムはノードが名詞または動詞を含むことを検証する
3. 学生が2つのノード間にリンクを作成するとき、システムはそのリンクの関係性の説明を保存する
4. 学生が概念マップを保存するとき、システムはすべてのノードとリンクを含むマップをFirestoreデータベースに永続化する
5. 学生が自分の概念マップを編集するとき、システムはFirestoreデータベースに保存されたデータを更新する

### 要件2

**ユーザーストーリー:** 教師として、トピックの見本となる概念マップを作成したい。そうすることで、学生に比較対象となる例を提供できる。

#### 受入基準

1. 教師が概念マップを作成するとき、システムは指定されたトピックの見本マップとしてマークする
2. 教師が見本概念マップを保存するとき、システムは学生の概念マップとの比較に利用可能にする
3. 教師が見本概念マップを編集するとき、システムは既存の比較に影響を与えずに見本マップを更新する

### 要件3

**ユーザーストーリー:** 教師として、学生の概念マップを自分の見本マップや他の学生のマップと比較したい。そうすることで、学生の理解度を評価できる。

#### 受入基準

1. 教師が1対1比較モードを選択するとき、システムは教師の見本マップと単一の学生マップの比較を許可する
2. 教師が教師対全学生比較モードを選択するとき、システムは教師の見本マップとトピックのすべての学生マップの比較を生成する
3. 教師が学生全体比較モードを選択するとき、システムはトピックのすべての学生マップ間の比較を生成する
4. 教師が一部学生比較モードを選択するとき、システムは教師が特定の学生マップを選択し、それらの間の比較を生成することを許可する
5. 比較が要求されるとき、システムは比較を実行する前にLLMサービスを呼び出して語彙調整を実行する

### 要件4

**ユーザーストーリー:** 教師として、学生が閲覧できる比較結果を制御したい。そうすることで、学習体験を適切に管理できる。

#### 受入基準

1. 教師が比較を生成するとき、システムはデフォルトで比較の可視性を非公開に設定する
2. 教師が比較の閲覧権限を付与するとき、システムは指定された学生がその比較にアクセスできるようにする
3. 教師が比較の閲覧権限を取り消すとき、システムは指定された学生のアクセスを削除する
4. 教師が比較の権限を更新するとき、システムは権限の変更をFirestoreデータベースに永続化する

### 要件5

**ユーザーストーリー:** 学生として、デフォルトで自分の概念マップのみを閲覧したい。そうすることで、明示的に共有されない限り、自分の作品をプライベートに保つことができる。

#### 受入基準

1. 学生がログインするとき、システムはその学生が作成した概念マップのみを表示する
2. 学生が概念マップを編集しようとするとき、システムは変更を許可する前に学生が所有者であることを検証する
3. 学生が他の学生の概念マップを閲覧しようとするとき、システムは比較を通じて明示的に許可されない限りアクセスを拒否する
4. 学生が概念マップを作成するとき、システムはFirestoreデータベースでその学生を所有者として設定する

### 要件6

**ユーザーストーリー:** 学生として、共有された比較結果を閲覧したい。そうすることで、自分の作品を他者と比較することから学ぶことができる。

#### 受入基準

1. 学生が比較を閲覧する権限を付与されたとき、システムは学生がアクセス可能な比較リストにその比較を表示する
2. 学生が許可された比較を閲覧するとき、システムは語彙調整された概念マップを並べて表示する
3. 学生が権限なしで比較を閲覧しようとするとき、システムはアクセスを拒否し適切なメッセージを表示する
4. 学生が1対1比較を閲覧する権限を持つとき、システムは学生が自分のマップを指定された見本マップと比較することを許可する

### 要件7

**ユーザーストーリー:** システム管理者として、語彙調整のためにLLMサービスと統合したい。そうすることで、異なる用語を使用した概念マップを意味のある形で比較できる。

#### 受入基準

1. システムが語彙調整を実行するとき、システムは設定されたLLMサービスにノードとリンクのテキストを送信する
2. gpt-oss-20Bが設定されているとき、システムは語彙調整にそのモデルを使用する
3. LM Studioが設定されているとき、システムはLM Studioに接続し、指定されたモデルを語彙調整に使用する
4. LLMサービスが調整された語彙を返すとき、システムは元の用語をストレージに保持しながら、調整された用語を比較に使用する
5. LLMサービスが応答に失敗した場合、システムはエラーを適切に処理し、ユーザーに通知する

### 要件8

**ユーザーストーリー:** 教師または学生として、認証を行い役割に応じた機能にアクセスしたい。そうすることで、システムが適切なアクセス制御を維持できる。

#### 受入基準

1. ユーザーがログインするとき、システムはFirebase認証に対してユーザーを認証する
2. 認証が成功したとき、システムはユーザーが教師か学生かを判定する
3. 教師がシステムにアクセスするとき、システムは比較管理と権限制御を含む教師専用機能へのアクセスを提供する
4. 学生がシステムにアクセスするとき、システムは概念マップ作成と許可された比較の閲覧を含む学生専用機能へのアクセスを提供する
5. ユーザーセッションが期限切れになったとき、システムはさらなるアクションを許可する前に再認証を要求する

### 要件9

**ユーザーストーリー:** 教師または学生として、概念マップをトピック毎に整理したい。そうすることで、比較が意味のある文脈に関連したものになる。

#### 受入基準

1. ユーザーが概念マップを作成するとき、システムはユーザーにトピックの指定を要求する
2. 教師が比較を開始するとき、システムは同じトピックの概念マップのみの選択を許可する
3. 学生が自分の概念マップを閲覧するとき、システムはトピック毎に整理して表示する
4. システムが概念マップを保存するとき、システムは効率的な取得のためにFirestoreデータベースでトピック毎にインデックスを作成する

### 要件10

**ユーザーストーリー:** システム管理者として、指定されたインフラストラクチャサービスとシステムを統合したい。そうすることで、アプリケーションが確実にデプロイされ動作する。

#### 受入基準

1. アプリケーションがデプロイされるとき、システムはCloudflareインフラストラクチャ上で実行する
2. システムがデータを保存または取得するとき、システムはpeer-resonant-concept-map2 Firestoreデータベースを使用する
3. システムがソースコードを管理するとき、システムはGitHubリポジトリyusuke-hayashi/PeerResonantConceptMapping2を使用する
4. システムがユーザー認証を処理するとき、システムはFirebase認証を使用する
5. システムがアプリケーションを提供するとき、システムはCloudflare CDNを通じてアセットを配信する
